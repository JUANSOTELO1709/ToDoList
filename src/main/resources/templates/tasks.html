<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Tareas - ToDoList</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.0/font/bootstrap-icons.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #6c757d;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --info: #17a2b8;
            --light: #f8f9fa;
            --dark: #343a40;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .task-card {
            transition: all 0.3s ease;
            border-left: 4px solid var(--primary);
            border-radius: 10px;
        }
        
        .task-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .task-card.completed {
            border-left-color: var(--success);
            opacity: 0.8;
            background: rgba(40, 167, 69, 0.05);
        }
        
        .task-card.overdue {
            border-left-color: var(--danger);
            background: rgba(220, 53, 69, 0.05);
        }
        
        .completed .task-title {
            text-decoration: line-through;
            color: var(--secondary) !important;
        }
        
        .badge-custom {
            font-size: 0.75em;
            padding: 0.35em 0.65em;
        }
        
        .btn-hover {
            transition: all 0.2s ease;
        }
        
        .btn-hover:hover {
            transform: scale(1.05);
        }
        
        .stats-card {
            background: linear-gradient(135deg, var(--primary), #5a67d8);
            color: white;
            border-radius: 15px;
        }
        
        .progress {
            height: 8px;
            border-radius: 4px;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .display-4 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container py-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="glass-card p-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h1 class="display-4 text-primary mb-0">
                                <i class="bi bi-check2-circle"></i> ToDoList
                            </h1>
                            <p class="text-muted mb-0">Gestiona tus tareas de forma eficiente</p>
                        </div>
                        <div class="text-end">
                            <span class="badge bg-primary rounded-pill fs-6">
                                <i class="bi bi-person-circle"></i>
                                <span th:text="${user.username}">Usuario</span>
                            </span>
                            <a href="/logout" class="btn btn-outline-danger btn-sm ms-2 btn-hover">
                                <i class="bi bi-box-arrow-right"></i> Salir
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="row mb-4">
            <div class="col-md-3 col-6 mb-3">
                <div class="stats-card p-3 text-center">
                    <i class="bi bi-list-task fs-1 mb-2"></i>
                    <h4 class="mb-0" th:text="${#lists.size(tasks)}">0</h4>
                    <small>Total Tareas</small>
                </div>
            </div>
            <div class="col-md-3 col-6 mb-3">
                <div class="stats-card p-3 text-center" style="background: linear-gradient(135deg, #28a745, #20c997);">
                    <i class="bi bi-check-circle fs-1 mb-2"></i>
                    <h4 class="mb-0" th:text="${#lists.size(tasks.?[status.name() == 'COMPLETADA'])}">0</h4>
                    <small>Completadas</small>
                </div>
            </div>
            <div class="col-md-3 col-6 mb-3">
                <div class="stats-card p-3 text-center" style="background: linear-gradient(135deg, #ffc107, #fd7e14);">
                    <i class="bi bi-clock fs-1 mb-2"></i>
                    <h4 class="mb-0" th:text="${#lists.size(tasks.?[status.name() == 'PENDIENTE'])}">0</h4>
                    <small>Pendientes</small>
                </div>
            </div>
            <div class="col-md-3 col-6 mb-3">
                <div class="stats-card p-3 text-center" style="background: linear-gradient(135deg, #dc3545, #e83e8c);">
                    <i class="bi bi-exclamation-triangle fs-1 mb-2"></i>
                    <h4 class="mb-0" th:text="${#lists.size(tasks.?[dueDate != null and dueDate.time < T(java.lang.System).currentTimeMillis() and status.name() == 'PENDIENTE'])}">0</h4>
                    <small>Vencidas</small>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="glass-card p-3">
                    <div class="d-flex flex-wrap gap-2">
                        <button class="btn btn-outline-primary btn-sm" onclick="filterTasks('all')">
                            <i class="bi bi-list-ul"></i> Todas
                        </button>
                        <button class="btn btn-outline-success btn-sm" onclick="filterTasks('completed')">
                            <i class="bi bi-check-circle"></i> Completadas
                        </button>
                        <button class="btn btn-outline-warning btn-sm" onclick="filterTasks('pending')">
                            <i class="bi bi-clock"></i> Pendientes
                        </button>
                        <button class="btn btn-outline-danger btn-sm" onclick="filterTasks('overdue')">
                            <i class="bi bi-exclamation-triangle"></i> Vencidas
                        </button>
                        <div class="ms-auto">
                            <input type="text" class="form-control form-control-sm" placeholder="Buscar tareas..." 
                                   onkeyup="searchTasks(this.value)" style="width: 200px;">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="row">
            <!-- Task Form -->
            <div class="col-lg-4 mb-4">
                <div class="glass-card p-4 h-100">
                    <h5 class="text-primary mb-4">
                        <i class="bi bi-plus-circle"></i> Nueva Tarea
                    </h5>
                    
                    <form th:action="@{/tasks/create}" method="post">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Título *</label>
                            <input type="text" class="form-control" name="title" 
                                   placeholder="¿Qué necesitas hacer?" required
                                   oninvalid="this.setCustomValidity('Por favor ingresa un título')"
                                   oninput="this.setCustomValidity('')">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">Descripción</label>
                            <textarea class="form-control" name="description" 
                                      placeholder="Detalles de la tarea (opcional)" 
                                      rows="3" style="resize: none;"></textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">Fecha Límite</label>
                            <input type="date" class="form-control" name="dueDate">
                            <small class="text-muted">Opcional - Para recordatorios</small>
                        </div>
                        
                        <button type="submit" class="btn btn-primary w-100 btn-hover">
                            <i class="bi bi-plus-circle"></i> Crear Tarea
                        </button>
                    </form>
                    
                    <!-- Quick User Actions -->
                    <div class="mt-4 pt-3 border-top">
                        <small class="text-muted">Acciones rápidas:</small>
                        <div class="d-flex gap-2 mt-2">
                            <a href="/create-user" class="btn btn-outline-info btn-sm">
                                <i class="bi bi-person-plus"></i> Crear Usuario Demo
                            </a>
                            <a href="/logout" class="btn btn-outline-secondary btn-sm">
                                <i class="bi bi-box-arrow-right"></i> Salir
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Task List -->
            <div class="col-lg-8">
                <div class="glass-card p-4">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5 class="text-primary mb-0">
                            <i class="bi bi-list-check"></i> Mis Tareas
                            <span class="badge bg-primary ms-2" th:text="${#lists.size(tasks)}"></span>
                        </h5>
                        <div class="text-muted">
                            <small th:text="'Actualizado: ' + ${#dates.format(#dates.createNow(), 'dd/MM/yyyy HH:mm')}"></small>
                        </div>
                    </div>

                    <!-- Empty State -->
                    <div th:if="${#lists.isEmpty(tasks)}" class="text-center py-5">
                        <i class="bi bi-inbox display-1 text-muted"></i>
                        <h5 class="text-muted mt-3">¡No hay tareas!</h5>
                        <p class="text-muted">Comienza creando tu primera tarea</p>
                        <button class="btn btn-primary btn-sm" onclick="document.querySelector('input[name=title]').focus()">
                            <i class="bi bi-plus"></i> Crear Primera Tarea
                        </button>
                    </div>

                    <!-- Task List -->
                    <div th:each="task : ${tasks}" th:id="'task-' + ${task.id}"
                         th:class="'task-card mb-3 p-3 ' + 
                                 (${task.status.name()} == 'COMPLETADA'} ? 'completed' : '') +
                                 (${task.dueDate} != null and ${task.dueDate.time} < ${T(java.lang.System).currentTimeMillis()} and ${task.status.name()} == 'PENDIENTE'} ? ' overdue' : '')">
                        
                        <div class="d-flex justify-content-between align-items-start">
                            <!-- Task Info -->
                            <div class="flex-grow-1">
                                <div class="d-flex align-items-center mb-1">
                                    <h6 class="task-title fw-bold mb-0 me-2" th:text="${task.title}"></h6>
                                    <span th:if="${task.dueDate} and ${task.dueDate.time} < T(java.lang.System).currentTimeMillis() and ${task.status.name()} == 'PENDIENTE'"
                                          class="badge bg-danger badge-custom">
                                        <i class="bi bi-exclamation-triangle"></i> Vencida
                                    </span>
                                </div>
                                
                                <p class="text-muted mb-2 small" th:if="${task.description}" 
                                   th:text="${task.description}"></p>
                                
                                <div class="d-flex flex-wrap gap-2 align-items-center">
                                    <!-- Status Badge -->
                                    <span th:class="'badge ' + (${task.status.name()} == 'COMPLETADA'} ? 'bg-success' : 'bg-warning') + ' badge-custom'">
                                        <i th:class="${task.status.name()} == 'COMPLETADA'} ? 'bi bi-check-circle' : 'bi bi-clock'"></i>
                                        <span th:text="${task.status.name()}"></span>
                                    </span>

                                    <!-- Due Date -->
                                    <span th:if="${task.dueDate}" class="badge bg-info badge-custom">
                                        <i class="bi bi-calendar"></i>
                                        <span th:text="${#dates.format(task.dueDate, 'dd/MM/yyyy')}"></span>
                                    </span>

                                    <!-- Days Left -->
                                    <span th:if="${task.dueDate} and ${task.status.name()} == 'PENDIENTE'"
                                          class="badge bg-secondary badge-custom">
                                        <i class="bi bi-clock"></i>
                                        <span th:text="'Días: ' + ${T(Math).max(0, (task.dueDate.time - T(java.lang.System).currentTimeMillis()) / (1000 * 60 * 60 * 24))}"></span>
                                    </span>
                                </div>
                            </div>

                            <!-- Actions -->
                            <div class="btn-group ms-3">
                                <!-- Toggle Status -->
                                <form th:action="@{'/tasks/' + ${task.id} + '/toggle'}" method="post" class="me-1">
                                    <button type="submit" 
                                            th:class="'btn btn-sm ' + (${task.status.name()} == 'COMPLETADA'} ? 'btn-outline-warning' : 'btn-outline-success') + ' btn-hover'"
                                            th:title="${task.status.name()} == 'COMPLETADA'} ? 'Marcar como pendiente' : 'Marcar como completada'">
                                        <i th:class="${task.status.name()} == 'COMPLETADA'} ? 'bi bi-arrow-counterclockwise' : 'bi bi-check-lg'"></i>
                                    </button>
                                </form>

                                <!-- Delete -->
                                <form th:action="@{'/tasks/' + ${task.id} + '/delete'}" method="post">
                                    <button type="submit" 
                                            class="btn btn-outline-danger btn-sm btn-hover"
                                            title="Eliminar tarea"
                                            onclick="return confirm('¿Estás seguro de eliminar esta tarea?')">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="text-center text-white">
                    <small>ToDoList App © 2024 - Desarrollado con Spring Boot y Bootstrap</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Custom JavaScript -->
    <script>
    // Filter tasks function
    function filterTasks(filter) {
        const tasks = document.querySelectorAll('.task-card');
        tasks.forEach(task => {
            switch(filter) {
                case 'completed':
                    task.style.display = task.classList.contains('completed') ? '' : 'none';
                    break;
                case 'pending':
                    task.style.display = !task.classList.contains('completed') ? '' : 'none';
                    break;
                case 'overdue':
                    task.style.display = task.classList.contains('overdue') ? '' : 'none';
                    break;
                default:
                    task.style.display = '';
            }
        });
    }

    // Search tasks function
    function searchTasks(query) {
        const tasks = document.querySelectorAll('.task-card');
        const searchTerm = query.toLowerCase();
        
        tasks.forEach(task => {
            const title = task.querySelector('.task-title').textContent.toLowerCase();
            const description = task.querySelector('.text-muted')?.textContent.toLowerCase() || '';
            
            if (title.includes(searchTerm) || description.includes(searchTerm)) {
                task.style.display = '';
            } else {
                task.style.display = 'none';
            }
        });
    }

    // AJAX functions
    function toggleTaskStatus(taskId) {
        fetch('/tasks/' + taskId + '/toggle', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => {
            if (response.ok) {
                location.reload();
            }
        })
        .catch(error => console.error('Error:', error));
    }

    function deleteTask(taskId) {
        if (confirm('¿Estás seguro de eliminar esta tarea?')) {
            fetch('/tasks/' + taskId + '/delete', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => {
                if (response.ok) {
                    document.getElementById('task-' + taskId).remove();
                    updateTaskCount();
                }
            })
            .catch(error => console.error('Error:', error));
        }
    }

    function updateTaskCount() {
        const taskCount = document.querySelectorAll('.task-card:not([style*="display: none"])').length;
        document.querySelector('.badge').textContent = taskCount;
    }

    // Auto-focus on title input
    document.addEventListener('DOMContentLoaded', function() {
        const titleInput = document.querySelector('input[name="title"]');
        if (titleInput) {
            titleInput.focus();
        }
    });
    </script>
</body>
</html>